name: Render and Publish to Medium

on:
  push:
    paths:
      - 'posts/**/*.qmd'
      - 'scripts/publish_to_medium.py'
  workflow_dispatch:
    inputs:
      post_folder:
        description: 'Post folder to render (e.g., "2025-11-06-landsat-composites"). Leave empty to render all posts.'
        required: false
        type: string

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Set up Quarto
        uses: quarto-dev/quarto-actions/setup@v2

      - name: Configure Earth Engine credentials (if provided)
        shell: bash
        run: |
          if [ -n "${{ secrets.EE_PRIVATE_KEY_JSON }}" ] && [ -n "${{ secrets.EE_SERVICE_ACCOUNT }}" ]; then
            echo "Writing EE service account key to gee-key.json"
            echo "${{ secrets.EE_PRIVATE_KEY_JSON }}" > gee-key.json
            echo "EE_SERVICE_ACCOUNT=${{ secrets.EE_SERVICE_ACCOUNT }}" >> $GITHUB_ENV
            echo "EE_KEY_PATH=$GITHUB_WORKSPACE/gee-key.json" >> $GITHUB_ENV
          else
            echo "No EE credentials provided; relying on default auth (may fail in CI)."
          fi

      - name: Determine changed posts
        id: changes
        shell: bash
        run: |
          set -euo pipefail
          # If manual trigger with a specific post folder, use that
          if [ -n "${{ inputs.post_folder }}" ]; then
            TARGET="posts/${{ inputs.post_folder }}/index.qmd"
            if [ -f "$TARGET" ]; then
              CHANGED="$TARGET"
            else
              echo "Error: $TARGET not found"
              exit 1
            fi
          # For manual trigger without input or when before/after are empty, use all posts
          elif [ -z "${{ github.event.before }}" ] || [ -z "${{ github.event.after }}" ]; then
            CHANGED=$(git ls-files 'posts/**/*.qmd' | tr '\n' ' ')
          else
            CHANGED=$(git diff --name-only "${{ github.event.before }}" "${{ github.event.after }}" -- 'posts/**/*.qmd' | tr '\n' ' ')
            if [ -z "$CHANGED" ]; then
              # fallback for squash merges or initial pushes
              CHANGED=$(git ls-files 'posts/**/*.qmd' | tr '\n' ' ')
            fi
          fi
          echo "Changed QMD files: $CHANGED"
          echo "files=$CHANGED" >> $GITHUB_OUTPUT

      - name: Render Quarto to GFM for changed posts
        if: steps.changes.outputs.files != ''
        shell: bash
        run: |
          set -euo pipefail
          for f in ${{ steps.changes.outputs.files }}; do
            echo "Rendering $f to GFM"
            quarto render "$f" --to gfm
          done

      - name: Render self-contained HTML for import (changed posts)
        if: steps.changes.outputs.files != ''
        shell: bash
        run: |
          set -euo pipefail
          for f in ${{ steps.changes.outputs.files }}; do
            echo "Rendering $f to self-contained HTML for Medium import"
            dir="$(dirname "$f")"
            base="$(basename "$f")"
            (
              cd "$dir"
              # Create a self-contained HTML (embeds images) to ensure Medium import has assets
              quarto render "$base" --to html -M format.html.self-contained=true --output "medium-import.html"
            )
            test -f "$dir/medium-import.html" || (echo "Expected $dir/medium-import.html not found" && exit 1)
          done

      - name: Upload Medium import HTML as artifact
        if: steps.changes.outputs.files != ''
        uses: actions/upload-artifact@v4
        with:
          name: medium-import-html-${{ github.sha }}
          if-no-files-found: error
          path: |
            posts/**/medium-import.html

      - name: Upload Markdown as artifact
        if: steps.changes.outputs.files != ''
        uses: actions/upload-artifact@v4
        with:
          name: medium-markdown-${{ github.sha }}
          if-no-files-found: error
          path: |
            posts/**/*.md

      - name: Medium import instructions (job summary)
        if: steps.changes.outputs.files != ''
        shell: bash
        run: |
          {
            echo "## Medium import"
            echo
            echo "Use Medium's Import tool: https://medium.com/p/import"
            echo
            echo "Artifacts produced:"
            echo "- HTML: medium-import-html-${{ github.sha }} (contains posts/**/medium-import.html)"
            echo "- Markdown: medium-markdown-${{ github.sha }} (contains posts/**/*.md)"
            echo
            echo "Files generated for changed posts:"
            for f in ${{ steps.changes.outputs.files }}; do
              dir=$(dirname "$f")
              [ -f "$dir/medium-import.html" ] && echo "- $dir/medium-import.html"
              md="${f%.qmd}.md"; [ -f "$md" ] && echo "- $md"
            done
            echo
            echo "Download the artifacts from this run and import either the HTML (recommended) or use the Markdown in Medium's editor."
          } >> "$GITHUB_STEP_SUMMARY"

      # Note: We intentionally omit committing rendered assets or publishing via Medium API,
      # since Medium no longer supports new API tokens. Import via artifact instead.
